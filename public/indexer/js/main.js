/**
 * <eyy-indexer-main> [https://github.com/sixem/eyy-indexer]
 * 
 * Licensed under GPL-3.0
 * @author   emy [admin@eyy.co]
 * @version  1.1.2
 */

"use strict";var lister={selection:{},selected:null,gallery:null,refresh:!1,defaults:{}};$(document).on("click","body > .top-bar > div.extend",function(e){return toggleMenu()}),$(document).on("click",".filter-container > div.close > span",function(e){return toggleFilter()}),$(document).on("input",'.filter-container > div input[type="text"]',function(e){return applyFilter($(e.currentTarget).val())}),$(document).on("click","body > div.menu #filter",function(e){toggleFilter(),toggleMenu()});var fallbackCopyTextToClipboard=function(e){var t=document.createElement("textarea");t.value=e,t.style.position="fixed",document.body.appendChild(t),t.focus(),t.select();try{var n=document.execCommand("copy");config.debug&&console.log("fallback","copying text command was "+(n?"successful":"unsuccessful"))}catch(e){config.debug&&console.error("fallback","unable to copy",e)}document.body.removeChild(t)},copyTextToClipboard=function(e){navigator.clipboard?navigator.clipboard.writeText(e).then(function(){config.debug&&console.log("async","copying to clipboard was successful.")},function(e){config.debug&&console.error("async","could not copy text: ",e)}):fallbackCopyTextToClipboard(e)},getReadableSize=function(e){if(0===e)return"0.00 B";var t=-1;do{e/=1024,t++}while(e>1024);return Math.max(e,.1).toFixed(1)+[" kB"," MB"," GB"," TB","PB","EB","ZB","YB"][t]},getCellValue=function(e,t){var n=$(e).children("td").eq(t).data("raw");return void 0!==n?n:$(e).children("td").eq(t).text()},comparer=function(e){return function(t,n){var i=getCellValue(t,e),o=getCellValue(n,e);return $.isNumeric(i)&&$.isNumeric(o)?i-o:i.localeCompare(o)}},getTableItems=function(){var e=[];return $("tr.file td:first-child a.preview").each(function(t,n){var i=(n=$(n)).closest("tr");if(i.is(":hidden"))return!0;var o=n.attr("href"),r=n.closest("td").data("raw"),l=i.find("td").eq(2).text();void 0!==o&&void 0!==r&&e.push({name:r,url:o,size:l})}),e},toggleMenu=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=$("body > div.menu");return t.css("display",!0===e||!1===e?e?"inline-block":"none":t.is(":hidden")?"inline-block":"none"),$("body > .top-bar > div.extend").html(t.is(":hidden")?"+":"-"),t.is(":hidden")},generateWGet=function(){var e=window.location.href,t=[];return $("tr.file td:first-child a:visible").each(function(e,n){var i=(n=$(n)).text().split(".").pop().toLowerCase().trim();t.includes(i)||t.push(i)}),'wget -r -np -nH -nd -e robots=off --accept "'.concat(t.join(","),'" "').concat(e,'"')};!0===config.gallery.enabled&&($(document).on("click","body > div.menu #gallery",function(e){load(null),toggleMenu(!1)}),$(document).on("click","tbody tr.file a.preview",function(e){if(e.preventDefault(),$(e.target).is("a")){var t=$(e.target).closest("table").find("tr.file:visible").filter(function(e,t){return $(t).find("a.preview").length>0}).index($(e.target).closest("tr.file"));load(-1!==t?t:0)}}));var timeout_copy=null;$(document).on("click","body > div.menu #copy",function(e){$(e.currentTarget);copyTextToClipboard(generateWGet()),toggleMenu(!1)}),$(document).on("click","table th span[sortable]",function(e){var t=$(e.currentTarget).is("th")?e.currentTarget:$(e.currentTarget).parents("th")[0],n=$(t).parents("table").eq(0),i=n.find("tbody tr.file").toArray().sort(comparer($(t).index()));t.asc=!t.asc,t.asc||(i=i.reverse());for(var o=0;o<i.length;o++)n.append(i[o]);lister.refresh=!0,lister.selected=null,$("tbody tr.last").removeClass("last")});var applyFilter=function(e){lister.refresh=!0;var t={reset:""===e,shown:{directories:0,files:0},hidden:{directories:0,files:0},size:0};$("body > table tr.file, body > table tr.directory").each(function(n,i){if(i=$(i),t.reset)return i.css("display",""),!0;var o=i.hasClass("file"),r=i.find("td:eq(0)").attr("data-raw").match(new RegExp(e,"i"));if(i.css("display",r?"":"none"),r&&o){var l=i.find("td:eq(2)").attr("data-raw");isNaN(l)||(t.size=t.size+parseInt(l))}r?o?t.shown.files++:t.shown.directories++:o?t.hidden.files++:t.hidden.directories++});var n={container:$("body > div.top-bar")};["size","files","directories"].forEach(function(e){return n[e]=n.container.find('[data-count="'.concat(e,'"]'))}),lister.defaults.hasOwnProperty("top_values")||(lister.defaults.top_values={size:n.size.text(),files:n.files.text(),directories:n.directories.text()}),n.size.text(t.reset?lister.defaults.top_values.size:getReadableSize(t.size)),n.files.text(t.reset?lister.defaults.top_values.files:"".concat(t.shown.files," file").concat(1===t.shown.files?"":"s")),n.directories.text(t.reset?lister.defaults.top_values.directories:"".concat(t.shown.directories," ").concat(1===t.shown.directories?"directory":"directories"));var i=$("body > div.menu > #gallery"),o=$("body > table tr.file:visible a.preview").length;!t.reset&&0===o&&i.length>0?"none"!==i.css("display")&&i.css("display","none"):(o>0||t.reset)&&i.length>0&&"none"===i.css("display")&&i.css("display","block")},toggleFilter=function(){var e=$(".filter-container"),t=e.find('input[type="text"]');e.is(":visible")?e.hide():(t.val(""),applyFilter(""),e.show()),t.focus()},hideOverlays=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:function(){},t=0;[{e:$(".filter-container"),func:toggleFilter},{e:$("body > div.menu"),func:toggleMenu}].forEach(function(e){e.e.length>0&&e.e.is(":visible")&&(e.func(),t++)}),e(t>0)},bind=function(){$(document).off("keydown").on("keydown",function(e){e.shiftKey&&70===e.keyCode?(e.preventDefault(),toggleFilter()):27===e.keyCode?hideOverlays(function(t){!0===t&&e.preventDefault()}):71===e.keyCode&&!0===config.gallery.enabled&&(load(null),toggleMenu(!1))})},load=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;if(config.debug&&console.log("load",e),!config.gallery.enabled)return!1;if(lister.gallery&&!1!==lister.gallery){var t=lister.refresh?getTableItems():null;return(null===t||0!==t.length)&&(lister.gallery.show(!0,null===e?lister.gallery.data.selected.index:e,t),void(lister.refresh&&(lister.refresh=!1)))}lister.gallery=new $.fn.gallery(getTableItems(),{start:null===e?0:e,filter:!1,console:config.debug,fade:config.gallery.fade,mobile:config.mobile,reverse_options:config.gallery.reverse_options,scroll_interval:config.gallery.scroll_interval}),!1!==lister.gallery&&$(lister.gallery).on("unbound",function(e,t){return bind()})},debounce=function(e){var t;return function(n){t&&clearTimeout(t),t=setTimeout(e,100,n)}},setAsc=function(){config.hasOwnProperty("sorting")&&config.sorting.enabled&&"asc"===config.sorting.order&&(0!==config.sorting.types&&1!==config.sorting.types||("name"===config.sorting.sort_by?$("table th span[sortable]").eq(0).parents("th")[0].asc=!0:"modified"===config.sorting.sort_by?$("table th span[sortable]").eq(1).parents("th")[0].asc=!0:"size"===config.sorting.sort_by&&($("table th span[sortable]").eq(2).parents("th")[0].asc=!0)))},createMenu=function(){var e=$("<div/>",{class:"menu"}).appendTo($("body")),t=[{text:"Filter",id:"filter"},{text:"Copy wget",id:"copy"}];return!0===config.gallery.enabled&&$("a.preview").length>0&&t.unshift({text:"Gallery",id:"gallery"}),t.forEach(function(t){$("<div/>",{id:t.id,text:t.text,class:"ns"}).appendTo(e)}),e};window.addEventListener("resize",debounce(function(e){config.mobile=Modernizr.mq("(max-width: 640px)")})),document.addEventListener("DOMContentLoaded",function(e){config.debug&&console.log("DOMContentLoaded")}),$(document).ready(function(){bind(),setAsc(),$('.filter-container > input[type="text"]').val(""),config.mobile=Modernizr.mq("(max-width: 640px)");var e=createMenu();if(e.css({top:$("body > div.top-bar").outerHeight()+"px",width:e.outerWidth()+"px",visibility:"unset",display:"none"}),!1===config.mobile&&!0===config.preview.enabled){var t=new $.fn.imagePreview({elements:["a.preview","div.preview"],hoverDelay:config.preview.hover_delay,windowMargin:config.preview.window_margin,staticPreview:config.preview.static,extensions:{images:config.extensions.image,videos:config.extensions.video}});!0===config.preview.cursor_indicator&&($(t).on("loaded",function(e,t){config.debug&&console.log("Loaded",t)}),$(t).on("loadChange",function(e,t){$("body > table tr.file a.preview").css("cursor",t?"progress":"pointer")}))}});