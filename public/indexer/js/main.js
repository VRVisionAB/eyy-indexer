/**
 * <eyy-indexer-main> [https://github.com/sixem/eyy-indexer]
 * 
 * @author   emy [admin@eyy.co]
 * @version  1.1.0
 */

"use strict";

var lister={selection:{},selected:null,gallery:null,refresh:!1,defaults:{}};$(document).on("click","body > .top-bar > div.extend",function(e){return toggleMenu()}),$(document).on("click",".filter-container > div.close > span",function(e){return toggleFilter()}),$(document).on("input",'.filter-container > div input[type="text"]',function(e){return applyFilter($(e.currentTarget).val())}),$(document).on("click","body > div.menu #filter",function(e){toggleFilter(),toggleMenu()});var fallbackCopyTextToClipboard=function(e){var t=document.createElement("textarea");t.value=e,t.style.position="fixed",document.body.appendChild(t),t.focus(),t.select();try{var i=document.execCommand("copy");config.debug&&console.log("fallback","copying text command was "+(i?"successful":"unsuccessful"))}catch(e){config.debug&&console.error("fallback","unable to copy",e)}document.body.removeChild(t)},copyTextToClipboard=function(e){navigator.clipboard?navigator.clipboard.writeText(e).then(function(){config.debug&&console.log("async","copying to clipboard was successful.")},function(e){config.debug&&console.error("async","could not copy text: ",e)}):fallbackCopyTextToClipboard(e)},getReadableSize=function(e){if(0===e)return"0.00 B";for(var t=-1;t++,1024<(e/=1024););return Math.max(e,.1).toFixed(1)+[" kB"," MB"," GB"," TB","PB","EB","ZB","YB"][t]},getCellValue=function(e,t){var i=$(e).children("td").eq(t).data("raw");return void 0!==i?i:$(e).children("td").eq(t).text()},comparer=function(o){return function(e,t){var i=getCellValue(e,o),n=getCellValue(t,o);return $.isNumeric(i)&&$.isNumeric(n)?i-n:i.localeCompare(n)}},getTableItems=function(){var l=[];return $("tr.file td:first-child a.preview").each(function(e,t){var i=(t=$(t)).closest("tr");if(i.is(":hidden"))return!0;var n=t.attr("href"),o=t.closest("td").data("raw"),r=i.find("td").eq(2).text();void 0!==n&&void 0!==o&&l.push({name:o,url:n,size:r})}),l},toggleMenu=function(e){var t=0<arguments.length&&void 0!==e?e:null,i=$("body > div.menu");return i.css("display",!0===t||!1===t?t?"inline-block":"none":i.is(":hidden")?"inline-block":"none"),$("body > .top-bar > div.extend").html(i.is(":hidden")?"+":"-"),i.is(":hidden")},generateWGet=function(){var e=window.location.href,n=[];return $("tr.file td:first-child a:visible").each(function(e,t){var i=(t=$(t)).text().split(".").pop().toLowerCase().trim();n.includes(i)||n.push(i)}),'wget -r -np -nH -nd -e robots=off --accept "'.concat(n.join(","),'" "').concat(e,'"')};!0===config.gallery.enabled&&($(document).on("click","body > div.menu #gallery",function(e){load(null),toggleMenu(!1)}),$(document).on("click","tbody tr.file a.preview",function(e){if(e.preventDefault(),$(e.target).is("a")){var t=$(e.target).closest("table").find("tr.file:visible").filter(function(e,t){return 0<$(t).find("a.preview").length}).index($(e.target).closest("tr.file"));load(-1!==t?t:0)}}));var timeout_copy=null;$(document).on("click","body > div.menu #copy",function(e){$(e.currentTarget);copyTextToClipboard(generateWGet()),toggleMenu(!1)}),$(document).on("click","table th span[sortable]",function(e){var t=$(e.currentTarget).is("th")?e.currentTarget:$(e.currentTarget).parents("th")[0],i=$(t).parents("table").eq(0),n=i.find("tbody tr.file").toArray().sort(comparer($(t).index()));t.asc=!t.asc,t.asc||(n=n.reverse());for(var o=0;o<n.length;o++)i.append(n[o]);lister.refresh=!0,lister.selected=null,$("tbody tr.last").removeClass("last")});var applyFilter=function(r){lister.refresh=!0;var l={reset:""===r,shown:{directories:0,files:0},hidden:{directories:0,files:0},size:0};$("body > table tr.file, body > table tr.directory").each(function(e,t){if(t=$(t),l.reset)return t.css("display",""),!0;var i=t.hasClass("file"),n=t.find("td:eq(0)").attr("data-raw").match(new RegExp(r,"i"));if(t.css("display",n?"":"none"),n&&i){var o=t.find("td:eq(2)").attr("data-raw");isNaN(o)||(l.size=l.size+parseInt(o))}n?i?l.shown.files++:l.shown.directories++:i?l.hidden.files++:l.hidden.directories++});var t={container:$("body > div.top-bar")};["size","files","directories"].forEach(function(e){return t[e]=t.container.find('[data-count="'.concat(e,'"]'))}),lister.defaults.hasOwnProperty("top_values")||(lister.defaults.top_values={size:t.size.text(),files:t.files.text(),directories:t.directories.text()}),t.size.text(l.reset?lister.defaults.top_values.size:getReadableSize(l.size)),t.files.text(l.reset?lister.defaults.top_values.files:"".concat(l.shown.files," file").concat(1===l.shown.files?"":"s")),t.directories.text(l.reset?lister.defaults.top_values.directories:"".concat(l.shown.directories," ").concat(1===l.shown.directories?"directory":"directories"));var e=$("body > div.menu > #gallery"),i=$("body > table tr.file:visible a.preview").length;!l.reset&&0===i&&0<e.length?"none"!==e.css("display")&&e.css("display","none"):(0<i||l.reset)&&0<e.length&&"none"===e.css("display")&&e.css("display","block")},toggleFilter=function(){var e=$(".filter-container"),t=e.find('input[type="text"]');e.is(":visible")?e.hide():(t.val(""),applyFilter(""),e.show()),t.focus()},hideOverlays=function(e){var t=0<arguments.length&&void 0!==e?e:function(){},i=0;[{e:$(".filter-container"),func:toggleFilter},{e:$("body > div.menu"),func:toggleMenu}].forEach(function(e){0<e.e.length&&e.e.is(":visible")&&(e.func(),i++)}),t(0<i)},bind=function(){$(document).off("keydown").on("keydown",function(t){t.shiftKey&&70===t.keyCode?(t.preventDefault(),toggleFilter()):27===t.keyCode&&hideOverlays(function(e){!0===e&&t.preventDefault()})})},load=function(e){var t=0<arguments.length&&void 0!==e?e:0;if(config.debug&&console.log("load",t),!config.gallery.enabled)return!1;if(lister.gallery&&!1!==lister.gallery){var i=lister.refresh?getTableItems():null;return(null===i||0!==i.length)&&(lister.gallery.show(!0,null===t?lister.gallery.data.selected.index:t,i),void(lister.refresh&&(lister.refresh=!1)))}lister.gallery=new $.fn.gallery(getTableItems(),{start:null===t?0:t,filter:!1,console:config.debug,fade:config.gallery.fade,mobile:config.mobile,reverse_options:config.gallery.reverse_options,scroll_interval:config.gallery.scroll_interval}),!1!==lister.gallery&&$(lister.gallery).on("unbound",function(e,t){return bind()})},debounce=function(t){var i;return function(e){i&&clearTimeout(i),i=setTimeout(t,100,e)}},createMenu=function(){var t=$("<div/>",{class:"menu"}).appendTo($("body")),e=[{text:"Filter",id:"filter"},{text:"Copy wget",id:"copy"}];return!0===config.gallery.enabled&&0<$("a.preview").length&&e.unshift({text:"Gallery",id:"gallery"}),e.forEach(function(e){$("<div/>",{id:e.id,text:e.text,class:"ns"}).appendTo(t)}),t};window.addEventListener("resize",debounce(function(e){config.mobile=Modernizr.mq("(max-width: 640px)")})),document.addEventListener("DOMContentLoaded",function(e){config.debug&&console.log("DOMContentLoaded")}),$(document).ready(function(){bind(),$('.filter-container > input[type="text"]').val(""),config.mobile=Modernizr.mq("(max-width: 640px)");var e=createMenu();if(e.css({top:$("body > div.top-bar").outerHeight()+"px",width:e.outerWidth()+"px",visibility:"unset",display:"none"}),!1===config.mobile&&!0===config.preview.enabled){var t=new $.fn.imagePreview({elements:["a.preview","div.preview"],hoverDelay:config.preview.hover_delay,windowMargin:config.preview.window_margin,staticPreview:config.preview.static,extensions:{images:config.extensions.image,videos:config.extensions.video}});!0===config.preview.cursor_indicator&&($(t).on("loaded",function(e,t){config.debug&&console.log("Loaded",t)}),$(t).on("loadChange",function(e,t){$("body > table tr.file a.preview").css("cursor",t?"progress":"pointer")}))}});